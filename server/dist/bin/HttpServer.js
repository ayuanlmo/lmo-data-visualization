"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},path_1=(Object.defineProperty(exports,"__esModule",{value:!0}),__importDefault(require("path"))),Express=require("express"),AppConfig_1=__importDefault(require("../conf/AppConfig")),utils_1=__importDefault(require("../utils")),router_1=__importDefault(require("../router")),Cli_1=__importDefault(require("../lib/Cli")),CreateErrorMessage=utils_1.default.createErrorMessage,WebSocketServer_1=require("./WebSocketServer"),HttpServer=function(){function e(){var e,t;this.App=Express(),this.WsApp=require("express-ws")(this.App),this.WsPool=null==(t=null==(e=this.WsApp)?void 0:e.getWss)?void 0:t.call(e,AppConfig_1.default.__SOCKET_CONNECT),this.onLineUsers=0,this.init()}return e.prototype.init=function(){var e,t,r=this;this.App.use(Express.json()),this.App.use(require("cors")()),this.App.use("/api",router_1.default),this.App.use(Express.urlencoded({extended:!1})),this.App.use(AppConfig_1.default.__STATIC_PATH,Express.static(path_1.default.resolve("./_data/".concat(AppConfig_1.default.__STATIC_PATH,"/public")))),this.App.use(function(e,t,r){return t.header("Access-Control-Allow-Origin","*"),t.header("Access-Control-Allow-Headers","Authorization,X-API-KEY, Origin, X-Requested-With, Content-Type, Accept, Access-Control-Request-Method"),t.header("Access-Control-Allow-Methods","GET, POST, OPTIONS, PATCH, PUT, DELETE"),t.header("Allow","GET, POST"),r()}),this.App.use(function(e,t,r){try{e.body=JSON.parse(JSON.stringify(e.body)),r()}catch(e){r(e)}}),this.App.use(function(e,t){t.status(200).json(CreateErrorMessage("ext00n",404))}),this.App.use(function(e,t,r){r.status(200).json(CreateErrorMessage("ext00e"))}),this.App.listen(AppConfig_1.default.__SERVER_PORT,function(){Cli_1.default.log("Server started on port ",AppConfig_1.default.__SERVER_PORT)}),null!=(t=(e=this.App).ws)&&t.call(e,AppConfig_1.default.__SOCKET_CONNECT,function(e){r.onLineUsers++,new WebSocketServer_1.WebSocketServer(e,r.onLineUsers,r.WsPool),null!=e&&e.on("close",function(){r.onLineUsers--})})},e}();exports.default=HttpServer;